## 高并发场景下一种基于缓存的分布式库存扣减方案

### 背景介绍

在一些高并发场景，类似于双十一红包雨的场景，该场景类似于秒杀，在整点几十上百万的用户同一时间涌入系统争抢红包。而红包本身是有限的，就要求需要在极短的时间内对红包的数量做正确的扣减，比如**每秒扣减100w次**，但任何系统、机器都是有其物理瓶颈存在。如何既能保证用户顺利领取到红包又不超发就成为一项非常困难的事情。

目前业界亦提出了多种库存扣减方案，其中性能最好的是**基于分布式**的库存扣减，即将库存提前分配至多个区块（桶）中，不同用户路由至不同的桶中，将***集中式的高并发流量打散至多个地方***。

![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/3282/1576414554448-f9fb56c5-fc78-4253-bd9b-9b3194035de4.png)

但在实际的场景中，库存提前分配会带来较多问题，包括碎片加剧、流量倾斜、无法动态扩容等等。在此背景下，基于分布式库存提出了一种库存扣减思路，即能够支撑海量高并发库存扣减，也能缓解或避免目前方案中产生的各类问题。

### 传统方案遇到的问题

#### **1. 库存无法释放**

库存在发放过程中还会有释放的场景，那么库存一次性分配到桶里就会导致库存无法释放，因为缓存本身不具备事实上的事务性，发放的同时释放未发放库存会有超发的潜在可能

#### **2. 库存有但无法发放**

分桶是基于一定的规则将请求动态路由至各个桶，如若出现了扣减数据倾斜则会导致个别桶发的快个别桶发的慢的情况，那么部分桶可能很快就发完了，路由进这个桶的请求都会提示没有库存，但实际全局角度看还有库存。

#### **3. 碎片问题加剧**

分桶是将库存均匀打散至各个桶中以均衡压力，但势必会造成桶发放到最后的过程中出现碎片发不出去的问题，比如桶内剩余2个，但实际一次性要扣减3个的导致无法扣减成功的情况，如果有64个桶，每个桶内剩余2个，那么就有128个库存无法发放

#### **4. 业务个性化定制场景**

所有技术方案均服务于具体业务场景，脱离使用场景谈技术方案都是刷流氓。在桶数量为固定数量的情况下，所有业务都为固定桶数量，不论库存深度有多少。假设固定分配64个桶，100个库存也会分64个桶，100亿也是64个桶，100qps是64个桶，1000w qps也是64个桶，有的业务有释放库存的需求，有的业务方无释放库存的需求等等，固定桶、库存提前分配无法做到依据业务变化的动态调配。

![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/3282/1576414949411-65c85eb7-f95f-4456-bd5b-9d29c3a558ef.png?x-oss-process=image/resize,w_1500)

上图是最终采取方案，我们针对整个扣减链路，增加扣减策略模块、库存调配模块用户库存的整体集中式管理，同时增加请求调度策略用户请求的动态调度。

### 具体实现方案

如上图，整个方案将扣减分为三大块，扣减策略模块、库存调配模块以及库存扣减模块。其中库存扣减模块真正的执行业务的扣减需求，扣减策略模块及库存调配模块均为库存扣减模块服务。业界原有方案我们归类于库存扣减模块中的一部分。

1）扣减策略模块决定了库存应当如何被发放，将扣减链路中可干预因素予以抽取，使得库存在扣减过程中能够被系统以及业务影响，从而扣减链路不再千篇一律，能够做到跟随业务动态变化

2）库存调配模块重新定义了库存分配策略，该模块用于做个性化的按需分配，库存不再是一刀切分配在各个桶中，而是随着发放速率的变大而变大，桶流量越大给分配的库存也就越多。同时该模块实时监控整个发放链路，对库存不足以支撑发放的桶依据规则进行扩容，或者停止该桶的发放

3）请求调度模块能够动态调配扣减请求，以保证请求永远能够被路由至有库存的桶执行扣减。

#### **扣减策略模块**

![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/3282/1576415500353-05d868f1-2320-4eec-ad80-4fd25b00bc66.png)

整个模块分为管理域配置子模块、扣减配置转换子模块

管理域配置子模块

配置支持系统生成功能，也允许使用方手动干预配置。配置信息主要包含以下4块部分：

**桶数量：**即桶的个数，默认依据库存深度来分配桶数量

**桶回源比例：**指桶内库存发放到什么比例时，需要回源中心桶继续拉取库存用于发放

**回源步长：**下文分桶扩容时的扩容多少库存至桶中

**桶下线阈值：**指中心桶已经明确无库存可以补充的情况下，桶内库存发的还剩多少时要下线不再发

#### 扣减配置转换子模块

##### 基本概念

管理域配置子模块生成扣减基础配置后，需要将其转换为真正的扣减数据才能进行真正的发放，本方案定义扣减数据分为四类：

**1、可扣减桶号表：**可扣减桶号中存储当前可以用于扣减的桶，主要用于下文的请求调度模块

**2、桶当前配置：**存储当前桶配置信息，包括桶可发放上限信息

**3、桶实际发放值：**存储当前扣减的实际值

**4、明细数据：**明细数据用于支撑幂等需求，如若扣减本身无幂等需求，则可以无该数据

 

##### 转换过程

转换过程用于将管理域数据及时的转换为扣减数据，该过程依赖于下文库存调配模块中提供的能力。该变化在数据上最主要需要感知桶数量的变化，如若桶变多，那么就需要及时的增加分桶，如若桶变少，则需要及时的将发放中的桶收回

 

### 库存调配模块

在实际的发放过程中，流量很难做到绝对的均衡。例如总计1万的库存深度，1000/s的扣减速率，配置10个桶，那么理想情况下，每个桶都承接100的qps。但实际过程中，可能A桶拿到了110/s的扣减速率，而B桶只拿到了80的扣减速率，在这种情况下，每个桶所发的库存数量也不会完全均衡，很可能A桶最终需要发1100个库存，B桶只需要发800个库存。如若我们将1万的库存均匀分布到10个桶中，就会导致A桶很快就不可发了，而B桶仍然能够发放。

本方案不再将库存一次性分配到桶中，而是渐进式的增加到各个分桶中，如下图所示。

![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/3282/1576416373723-84a7db34-ead2-4c69-b561-e08cf666ff60.png?x-oss-process=image/resize,w_1500)

库存腾挪过程

一开始的库存主要在中心桶中，发放过程中如蚂蚁搬家式的逐步挪进各个分桶。此过程中就会出现分桶扩容以及分桶缩容部分。

本部分包括分桶列表管理子模块以及分桶管理子模块，其中

> 分桶列表管理子模块主要用于管理桶的分布，包括上线下线、增加减少等
>
> 分桶管理子模块用于管理具体某个分桶的情况，比如扩容缩容等

#### 分桶列表管理子模块

##### 分桶上线

分桶上线是指将桶序号挂载至可扣减桶号列表中，挂载至列表中，下文请求调度模块就会将流量引导至桶中执行扣减操作

##### 分桶下线

分桶下线是分桶上限的缩容，是指将桶序号从可扣减桶号列表中摘除，从列表中摘除，下文请求调度模块就会将流量引导走，该桶库存也就不会再执行扣减诉求

##### 分桶增加

分桶增加是分桶扩容+分桶上线的结合，一旦确定桶需要增加，那么桶势必要执行扩容操作才能正常发放，链路可参考下图

##### 分桶减少

分桶增加是分桶扩容+分桶上线的结合，一旦确定桶需要增加，那么桶势必要执行扩容操作才能正常发放，链路可参考下图

![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/3282/1576416313449-6505710d-7d13-4ef9-8717-527e632bb8f4.png?x-oss-process=image/resize,w_1500)

#### 分桶管理子模块

##### 分桶扩容

各个分桶是最终承载扣减的实体，所以各个分桶内必须有库存才能够用于扣减，分桶扩容就是指将中心桶库存加载至各个分桶的过程。图4表明了整个库存的流动情况。刚开始情况下所有库存均在中心桶，扩容操作会将扣减策略模块的回源步长扩充至分桶内

##### 分桶缩容

分桶缩容是分桶扩容的逆向，即桶内可发放库存被回收的过程。主要是分桶因为各类原因变为不可用后，分桶内的未发放库存需要被释放出来，否则会导致未发库存的不可发情况出现

###  

### 库存扣减模块

库存扣减模块最终承载了库存的真实发放诉求，扣减策略模块及库存调配模块的所有逻辑均为库存扣减所做准备。整体链路是将原本固定的路由发放改变为可系统调配的链路，从而解决某个桶库存没有但是还有请求过去导致的问题。

整体方案可参考如下图：

![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/3282/1576416974393-815b6bf6-5e01-4b42-bce1-183b0dd74e8c.png?x-oss-process=image/resize,w_1500)

![img](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/3282/1576743875590-e629755a-dbff-401a-ae97-cc233729ecef.png?x-oss-process=image/resize,w_1500)

 

### 最终整体扣减链路图

![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2019/png/3282/1576417007521-43d2b647-8ee3-4edf-82ee-f115cf5ffcd7.png?x-oss-process=image/resize,w_1500)

 

## 效果

### 目前应用场景

该方案方案初步于19年618应用于红包雨场景，99前实现了产品化，平稳支持了618、88、99、双十一、双十二等历次大促的大流量权益发放场景。目前已成为拉菲的默认库存扣减策略，所有权益发放活动无论大小均走该分桶方案

 

### 关键指标

分桶发放过程中

> 秒级库存扩容
>
> 对于某一分桶库存售罄的场景，能够做到桶的秒级摘除，10s左右流量全部从该空桶切除（秒级切除改进中）
>
> 设置端桶数量增加，发放链路基本秒级感知，5s内能够支撑库存发放
>
> 设置端桶数量减少，2分钟分桶内库存回流至中心桶后续计划

## 目前遗留问题

1、由于目前缓存计数器采取tair的incr以及decr，而tair针对该方法只能支持int最大值的扣减，此对于方案影响较大，后续可能考虑在解决原子性的情况下使用redis实现计数

2、业务下游的库存扣减感知的实时度情况，比如业务需要库存每变动1%时做xxx事情，在db集中式扣减的过程中，我们可以监听drc消息就能准确的判断出来，然后通知下游。目前由于总库存本质上还是定时收集得到，实时性无法保证

3、库存的售罄消息实时性，此问题与问题2基本相同，均为分布式场景下的集中管理实时性要求，目前尚无较好的办法

4、某分桶售罄需要10s左右才能将流量全部切走，计划后续采取请求二次调度的方案解决